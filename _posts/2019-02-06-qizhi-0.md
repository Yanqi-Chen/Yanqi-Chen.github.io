---
layout: post
title:  qizhiçš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶ï¼ˆä¸€ï¼‰
date:   2019-02-06
subtitle:   è°ƒåº¦æµç¨‹åˆæ¢
author:     CYQ
header-img: img/cs_0.jpg
catalog: true
sitemap: false
tags:
  - Hadoop
  - Yarn
  - æœ¬ç§‘æ¯•è®¾
typora-root-url: ..
---

* TOC
{:toc}

AMåœ¨Yarnä¸­è´Ÿè´£åº”ç”¨çš„ç›‘æ§ï¼Œè·Ÿè¸ªåº”ç”¨æ‰§è¡ŒçŠ¶æ€ï¼Œé‡å¯å¤±è´¥ä»»åŠ¡ç­‰ï¼Œæ˜¯è°ƒåº¦å·¥ä½œçš„ç»å¯¹æ ¸å¿ƒã€‚åœ¨å…¶åˆå§‹åŒ–å‡½æ•°ä¸­ä¼šå¯åŠ¨NMï¼ŒRMï¼ŒYarnçš„clientï¼ŒåŒæ—¶å¯åŠ¨ZookeeperStoreï¼ŒStatusManagerï¼ŒrequestManagerï¼ŒSelectionManagerç­‰æœåŠ¡ã€‚è°ƒåº¦ä¹Ÿå›´ç»•è¿™äº›æœåŠ¡è¿›è¡Œã€‚

# RequestManageréƒ¨åˆ†

RequestManagerå°†ä¼šå®šæ—¶è¿›è¡Œå‘¨æœŸçš„PullRequestã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šä»ZookeeperStoreè·å¾—æ–°çš„Requestä¿¡æ¯ã€‚ä¸»è¦æ¥è¯´ï¼Œä¾æ¬¡è°ƒç”¨ä»¥ä¸‹è‹¥å¹²ä¸ªå‡½æ•°å¤„ç†Requestï¼š

- `updateFrameworkDescriptor`ï¼šå½“FrameworkDescriptorå‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œå¤„ç†ã€‚è¿™æ˜¯è°ƒåº¦çš„ä¸€ä¸ªé‡è¦å‡½æ•°ï¼Œå› ä¸ºæ­¤å¤„ä¼šæ£€æµ‹åˆ°FrameworkDescriptorä¸­taskRolesçš„å˜åŒ–ï¼Œå¯¹äºæ–°ä»»åŠ¡æ¥è¯´ï¼Œè¿™é‡Œé¢æ›´æ–°çš„å†…å®¹å°±æ˜¯æ–°å¢çš„æ‰€æœ‰ä»»åŠ¡
- `updateOverrideApplicationProgressRequest`ï¼šæš‚ä¸æ¸…æ¥šï¼Œä½†æ˜¯ä»å‡½æ•°çš„å®ç°æ¥çœ‹ï¼Œåšçš„æ˜¯ä¸€ä¸ªæ‰€æœ‰ä»»åŠ¡é…ç½®æ–‡ä»¶çš„Overrideï¼Œä¸è°ƒåº¦å…³ç³»åº”å½“ä¸å¤§ï¼ˆ**éœ€è¦ç¡®è®¤**ï¼‰
- `updateMigrateTaskRequests`ï¼šåœ¨AMç»“æŸå®¹å™¨æˆ–è€…ç”¨æˆ·æ‰‹åŠ¨ç»“æŸå®¹å™¨æ—¶è¿›è¡Œæ”¶å°¾å·¥ä½œï¼ˆåƒåœ¾å›æ”¶ç­‰ï¼‰ï¼Œä¸è°ƒåº¦æ— å…³

å› æ­¤ä¸è°ƒåº¦ç›¸å…³çš„å°±æ˜¯`updateFrameworkDescriptor`ï¼Œå†è¿›åˆ°é‡Œé¢å»çœ‹çœ‹å¹²äº†å•¥ï¼š

é¦–å…ˆç”±äºRequestå‘ç”Ÿäº†æ›´æ–°ï¼Œéœ€è¦æ›´æ–°requestManagerè‡ªèº«çš„æ•°æ®ç»“æ„ï¼Œæ›´æ–°ä»»åŠ¡ä¿¡æ¯ã€‚ä½†æ˜¯èƒ½åšçš„ä¹Ÿä»…é™äºæ­¤ï¼Œæ¥ä¸‹æ¥éœ€è¦é€šçŸ¥AMå‘ç”Ÿäº†ä»»åŠ¡æ•°é‡çš„å˜åŒ–ï¼Œè®©AMå¯¹æ–°ä»»åŠ¡è¿›ä¸€æ­¥å¤„ç†ï¼Œå…·ä½“åšæ³•æ˜¯ä¼šç›´æ¥è°ƒç”¨AMçš„`onTaskNumbersUpdated`

# AMéƒ¨åˆ†

æ­¤å¤„ä¼šè°ƒç”¨`transitionTaskStateQueue.queueSystemTask`å°†ä¸€ä¸ªå‡½æ•°çš„æ‰§è¡ŒåŠ å…¥é˜Ÿåˆ—ï¼Œè¿™äº›å‡½æ•°çš„ä»»åŠ¡éƒ½æ¶‰åŠåˆ°ä»»åŠ¡çš„FSMçš„çŠ¶æ€è½¬æ¢ï¼Œæ­¤å¤„çš„å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š

é¦–å…ˆä¼šè°ƒç”¨StatusManagerçš„`updateTaskNumbers`å¯¹å…¶è®°å½•çš„æ•°æ®ç»“æ„è¿›è¡Œä¿®æ”¹ï¼Œæ­¤å¤„ä¼šæŠŠæ–°çš„ä»»åŠ¡çš„çŠ¶æ€åˆå§‹åŒ–ä¸ºç©ºã€‚ç„¶åå¯åŠ¨å®¹å™¨é€‰æ‹©ä¸åˆ†é…å‡½æ•°`addContainerRequest()`çš„æ— å‚æ•°ç‰ˆæœ¬ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿›ä¸€æ­¥éå†æ‰€æœ‰å¤„äºçŠ¶æ€TASK_WAITINGçš„ä»»åŠ¡ï¼Œæ ¹æ®ä¼˜å…ˆçº§ï¼Œç”¨ä¸€ä¸ªå¾ªç¯é€ä¸ªè°ƒç”¨`addContainerRequest(taskStatus)`

åœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¸€å¼€å§‹å°±ä¼šè¿›è¡Œèµ„æºçš„åˆ†é…ä¸ç”³è¯·ï¼Œå³èµ„æºçš„è°ƒåº¦ï¼Œä¸»è¦å‡½æ•°æ˜¯`setupContainerRequest`ï¼Œè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œä¼šç›´æ¥å°†è¯¥ä»»åŠ¡çš„åˆ†é…æ¨è¿ŸsetupContainerRequestRetryIntervalSec * 1000æ—¶é—´ä¹‹åå†æ¬¡åŠ å…¥transitionTaskStateQueueã€‚å¹¶ä¸”ç›´æ¥è¿”å›ï¼Œè¿™æ ·åšå°±æ˜¯å› ä¸ºè¿™ä¸ªå‡½æ•°å¹²çš„äº‹å¤ªé‡è¦äº†ï¼Œå®ƒçœŸæ­£å‘Hadoopå‘å‡ºäº†èµ„æºè¯·æ±‚ï¼Œå¹¶ä¸”å†³å®šäº†èµ„æºå¦‚ä½•è°ƒåº¦ã€‚

## setupContainerRequest

è¿™ä¸ªå‡½æ•°å°±æ˜¯çœŸæ­£çš„è°ƒåº¦å‡½æ•°å•¦ã€‚é¦–å…ˆï¼Œä¼šæŸ¥çœ‹å½“å‰æ‰€éœ€çš„èµ„æºæ˜¯å¦è¶…è¿‡äº†é›†ç¾¤é»˜è®¤é…ç½®çš„æœ€å¤§å€¼ã€‚

```java
    ResourceDescriptor requestResource = requestManager.getTaskResources().get(taskRoleName);
    ResourceDescriptor maxResource = conf.getMaxResource();
    if (!ResourceDescriptor.fitsIn(requestResource, maxResource)) {
      LOGGER.logWarning(
          "Request Resource does not fit in the Max Resource configured in current cluster, " +
              "request may fail or never get satisfied: " +
              "Request Resource: [%s], Max Resource: [%s]",
          requestResource, maxResource);
    }
```

 è¶…è¿‡çš„è¯å½“ç„¶æ¥ä¸‹æ¥æ€ä¹ˆè°ƒåº¦éƒ½ä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥çœ‹ä¸‹é¢çš„ä»£ç ã€‚

```java
    if (requestResource.getGpuNumber() > 0 || requestResource.getPortNumber() > 0) {
      updateNodeReports(yarnClient.getNodeReports(NodeState.RUNNING));
      SelectionResult selectionResult = selectionManager.selectSingleNode(taskRoleName);

      ResourceDescriptor optimizedRequestResource = selectionResult.getOptimizedResource();
      if (selectionResult.getNodeHosts().size() > 0) {
        return HadoopUtils.toContainerRequest(optimizedRequestResource, requestPriority, null, selectionResult.getNodeHosts().get(0));
      }
      return HadoopUtils.toContainerRequest(optimizedRequestResource, requestPriority, requestNodeLabel, null);
    }
    return HadoopUtils.toContainerRequest(requestResource, requestPriority, requestNodeLabel, null);
```

å¦‚æœå½“å‰çš„ä»»åŠ¡æœ‰ç«¯å£å·æˆ–è€…GPUéœ€æ±‚çš„è¯ï¼Œå°±è¿›å…¥å†…å±‚åˆ†é…ï¼Œå¦åˆ™ç›´æ¥å‘Hadoopè¯·æ±‚ï¼ˆè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼ŒCPUå°±ä¸ç”¨è°ƒåº¦äº†ä¹ˆğŸ˜‚ï¼‰ï¼Œæ¥ä¸‹æ¥çœ‹å†…å±‚ã€‚

yarnClientè·å¾—æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œè®©selectionManagerè°ƒç”¨`selectSingleNode`é€‰æ‹©å•ä¸ªèŠ‚ç‚¹ç„¶åå‘Hadoopç”³è¯·èµ„æºçš„è¯·æ±‚ã€‚

**æ‰“ä½**

å¾ˆæ˜æ˜¾ï¼Œ`selectSingleNode`è¿™ä¸ªå‡½æ•°å¯¹èŠ‚ç‚¹è¿›è¡Œäº†é€‰æ‹©ã€‚è¿™é‡Œé¢å°±æ˜¯æˆ‘ä»¬æ‰€è¦æ‰¾çš„åŸå§‹è°ƒåº¦ç®—æ³•ä»£ç ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä¼šè¯¦ç»†åˆ†æåŸå§‹ç®—æ³•ï¼Œå¹¶ä¸”æå‡ºä¿®æ”¹çš„æ€è·¯ã€‚